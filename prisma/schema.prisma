// Esquema para el nuevo sistema course-based
// Sin persistencia de usuarios - todo basado en cursos y sesiones
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// Modelo de Curso (sin usuario asociado)
model Course {
  id              String   @id @default(cuid())
  moodleCourseId  String   @unique
  name            String
  shortName       String?
  lastAnalyzedBy  String?  // Matrícula del último profesor que analizó
  lastSync        DateTime?
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Relaciones
  groups          Group[]
  analysisResults AnalysisResult[]
  
  @@index([moodleCourseId])
  @@index([lastAnalyzedBy])
}

// Modelo de Grupo dentro de un Curso
model Group {
  id              String   @id @default(cuid())
  moodleGroupId   String   @unique
  name            String
  courseId        String
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Relaciones
  course          Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  analysisResults AnalysisResult[]
  
  @@index([courseId])
  @@index([moodleGroupId])
}

// Modelo de Resultado de Análisis (course-based)
model AnalysisResult {
  id              String   @id @default(cuid())
  
  // Identificadores del curso y grupo
  courseId        String
  moodleCourseId  String   // Redundante pero útil para queries
  groupId         String?
  moodleGroupId   String?  // Redundante pero útil para queries
  
  // Profesor que realizó el análisis (sin FK, solo referencia)
  analyzedBy      String   // Matrícula del profesor
  analyzedByName  String?  // Nombre del profesor (cache)
  
  // Tipo de análisis
  analysisType    String   // 'COURSE_OVERVIEW', 'ACTIVITY_ANALYSIS', etc.
  
  // Resultados del análisis
  strengths       Json     // Array de fortalezas identificadas
  alerts          Json     // Array de alertas o problemas
  recommendations Json?    // Array de recomendaciones
  nextStep        String   // Sugerencia de próximo paso
  overallHealth   String?  // 'buena', 'regular', 'necesita atención'
  studentsAtRisk  String?  // Descripción de estudiantes en riesgo
  
  // Datos adicionales
  rawData         Json?    // Datos crudos de Moodle
  llmResponse     Json?    // Respuesta completa del LLM
  
  // Métricas del análisis
  studentsAnalyzed Int?    // Número de estudiantes analizados
  activitiesCount  Int?    // Número de actividades analizadas
  forumsCount      Int?    // Número de foros analizados
  
  // Metadatos
  processedAt     DateTime @default(now())
  isLatest        Boolean  @default(true)
  confidence      Float?   // Nivel de confianza del análisis (0-1)
  
  // Relaciones
  course          Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  group           Group?   @relation(fields: [groupId], references: [id], onDelete: Cascade)
  
  @@index([courseId])
  @@index([groupId])
  @@index([moodleCourseId])
  @@index([analyzedBy])
  @@index([isLatest])
  @@index([processedAt])
  @@index([analysisType])
}

// Modelo para Análisis de Actividades Individuales
model ActivityAnalysis {
  id              String   @id @default(cuid())
  
  // Identificadores de la actividad
  courseId        String
  moodleCourseId  String   // ID del curso en Moodle
  activityId      String   // ID de la actividad en Moodle
  activityType    String   // 'forum', 'assign', 'quiz', etc.
  activityName    String   // Nombre de la actividad
  
  // Análisis completo
  summary         String   // Resumen del análisis
  positives       Json     // Array de aspectos positivos
  alerts          Json     // Array de alertas/problemas
  insights        Json     // Array de insights clave
  recommendation  String   // Recomendación principal
  fullAnalysis    String?  // Análisis completo en formato Markdown
  
  // Análisis específico por tipo
  forumAnalysis   Json?    // Análisis específico de foros
  assignAnalysis  Json?    // Análisis específico de tareas
  
  // Datos originales y respuesta completa
  activityData    Json     // Datos completos de la actividad
  llmResponse     Json     // Respuesta completa del LLM
  
  // Metadatos
  generatedAt     DateTime @default(now())
  lastUpdated     DateTime @updatedAt
  isValid         Boolean  @default(true)
  
  // Índices para búsqueda rápida
  @@unique([courseId, activityId, activityType])
  @@index([courseId])
  @@index([activityId])
  @@index([activityType])
  @@index([generatedAt])
  @@index([lastUpdated])
}

// Modelo de Jobs para el sistema de colas
model JobLog {
  id              String   @id @default(cuid())
  jobId           String   @unique
  jobType         String   // 'scheduled' o 'on-demand'
  status          String   // 'pending', 'processing', 'completed', 'failed'
  courseId        String?
  groupId         String?
  analyzedBy      String?  // Matrícula del profesor
  error           String?
  startedAt       DateTime?
  completedAt     DateTime?
  createdAt       DateTime @default(now())
  
  @@index([status])
  @@index([createdAt])
  @@index([analyzedBy])
}

// Modelo de Caché Persistente para mantener datos entre sesiones
model CourseCache {
  id                  String   @id @default(cuid())
  courseId            String   // ID del curso en formato "courseId|groupId"
  
  // Datos cacheados
  activities          Json     // Actividades abiertas
  analysisResults     Json     // Resultados de análisis
  activitiesSummary   Json?    // Resumen de actividades
  courseAnalysisId    String?  // ID del análisis del curso
  
  // Metadatos del caché
  lastFetched         DateTime // Timestamp de la última actualización
  expiresAt           DateTime // Cuándo expira este caché (1 hora después de lastFetched)
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  
  // Para limpiezas automáticas
  isActive            Boolean  @default(true)
  
  @@unique([courseId])
  @@index([expiresAt])
  @@index([lastFetched])
  @@index([isActive])
}

// Modelo de Cola de Análisis para procesamiento en background
model AnalysisQueue {
  id              String   @id @default(cuid())
  courseId        String   // ID del curso en formato "courseId|groupId"
  activityId      String   // ID de la actividad en Moodle
  activityType    String   // Tipo: 'assign', 'forum', etc.
  activityName    String   // Nombre de la actividad
  
  // Estado del análisis
  status          String   // 'pending', 'processing', 'completed', 'failed'
  priority        Int      @default(0) // Prioridad (mayor número = mayor prioridad)
  
  // Datos de la actividad para el análisis
  activityData    Json     // Datos completos de la actividad
  
  // Resultados (si completado)
  analysisResult  Json?    // Resultado del análisis
  
  // Control de intentos
  attempts        Int      @default(0)
  maxAttempts     Int      @default(3)
  lastError       String?
  
  // Metadatos
  requestedBy     String?  // Quién solicitó el análisis
  requestedAt     DateTime @default(now())
  startedAt       DateTime?
  completedAt     DateTime?
  
  // Índices para optimización
  @@unique([courseId, activityId, activityType])
  @@index([status])
  @@index([priority])
  @@index([requestedAt])
  @@index([courseId])
}