// Nuevo esquema simplificado - Course-based
// No persiste usuarios, solo cursos y análisis

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Modelo de Curso (independiente de usuarios)
model Course {
  id              String   @id @default(cuid())
  moodleCourseId  String   @unique
  name            String
  shortName       String?
  lastAnalyzedBy  String?  // Matrícula del último profesor que hizo análisis  
  isActive        Boolean  @default(true)
  lastSync        DateTime?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Relaciones
  groups          Group[]
  analysisResults AnalysisResult[]
  
  @@index([moodleCourseId])
  @@index([lastAnalyzedBy])
}

// Modelo de Grupo dentro de un Curso
model Group {
  id              String   @id @default(cuid())
  moodleGroupId   String   @unique
  name            String
  courseId        String
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Relaciones
  course          Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  analysisResults AnalysisResult[]
  
  @@index([courseId])
  @@index([moodleGroupId])
}

// Modelo de Resultado de Análisis (asociado a curso, no a usuario)
model AnalysisResult {
  id              String   @id @default(cuid())
  
  // Identificación del curso y grupo
  courseId        String   // ID interno del curso
  moodleCourseId  String   // ID del curso en Moodle (para búsquedas directas)
  groupId         String?  // ID interno del grupo (opcional)
  moodleGroupId   String?  // ID del grupo en Moodle (opcional)
  
  // Metadatos del análisis
  analysisType    String   // 'COURSE_OVERVIEW', 'FORUM_PARTICIPATION', 'ACTIVITY_SUBMISSION', etc.
  
  // Información del profesor que realizó el análisis (no FK, solo referencia)
  analyzedBy      String   // Matrícula del profesor
  analyzedByName  String?  // Nombre del profesor (opcional)
  
  // Resultados del análisis
  strengths       Json     // Array de fortalezas identificadas
  alerts          Json     // Array de alertas o problemas
  recommendations Json?    // Array de recomendaciones (opcional)
  nextStep        String   // Sugerencia de próximo paso
  overallHealth   String?  // 'buena', 'regular', 'necesita atención'
  studentsAtRisk  String?  // Descripción de estudiantes en riesgo
  
  // Datos adicionales
  rawData         Json?    // Datos crudos de Moodle (opcional)
  llmResponse     Json?    // Respuesta completa del LLM (opcional)
  
  // Metadatos del procesamiento
  processedAt     DateTime @default(now())
  isLatest        Boolean  @default(true)
  confidence      Float?   // Nivel de confianza del análisis (0-1)
  
  // Información técnica del análisis
  studentsAnalyzed Int?    // Número de estudiantes analizados
  activitiesCount  Int?    // Número de actividades analizadas
  forumsCount      Int?    // Número de foros analizados
  processingTimeMs Int?    // Tiempo de procesamiento en ms
  
  // Relaciones
  course          Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  group           Group?   @relation(fields: [groupId], references: [id], onDelete: Cascade)
  
  @@index([courseId])
  @@index([moodleCourseId])
  @@index([groupId])
  @@index([analyzedBy])
  @@index([isLatest])
  @@index([processedAt])
  @@index([analysisType])
}

// Modelo de Jobs para el sistema de análisis
model JobLog {
  id              String   @id @default(cuid())
  jobId           String   @unique
  jobType         String   // 'scheduled' o 'on-demand'
  status          String   // 'pending', 'processing', 'completed', 'failed'
  
  // Contexto del job
  courseId        String?
  moodleCourseId  String?
  groupId         String?
  analyzedBy      String?  // Matrícula del profesor
  
  // Resultados y errores
  error           String?
  result          Json?    // Resultado del análisis (opcional)
  
  // Timing
  startedAt       DateTime?
  completedAt     DateTime?
  processingTimeMs Int?
  createdAt       DateTime @default(now())
  
  @@index([status])
  @@index([createdAt])
  @@index([analyzedBy])
  @@index([moodleCourseId])
}